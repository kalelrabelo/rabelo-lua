<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lua - Assistente IA</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <style>
        @keyframes pulse-sphere {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .sphere-pulse {
            animation: pulse-sphere 0.5s ease-in-out;
        }
        
        .fade-in {
            animation: fadeIn 1s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .conversation-mode {
            background: radial-gradient(circle at center, rgba(0,0,50,0.9), rgba(0,0,0,0.95));
            backdrop-filter: blur(10px);
        }
        
        .energy-sphere-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .energy-sphere {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 100px rgba(0, 150, 255, 0.5);
        }
        
        .audio-visualizer {
            position: absolute;
            bottom: 20%;
            width: 80%;
            height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
        }
        
        .audio-bar {
            width: 4px;
            background: linear-gradient(to top, #0096ff, #00ffff);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        function LuaAssistant() {
            const [conversationMode, setConversationMode] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [isSpeaking, setIsSpeaking] = useState(false);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const [sphereScale, setSphereScale] = useState(1);
            const [audioContext, setAudioContext] = useState(null);
            const [analyser, setAnalyser] = useState(null);
            const [wsConnection, setWsConnection] = useState(null);
            const videoRef = useRef(null);
            const audioRef = useRef(null);
            const recognitionRef = useRef(null);
            
            // Initialize WebSocket connection
            useEffect(() => {
                if (conversationMode) {
                    const ws = new WebSocket(`ws://${window.location.host}/ws`);
                    
                    ws.onopen = () => {
                        console.log("WebSocket conectado");
                        setMessages(prev => [...prev, {
                            type: 'system',
                            text: 'Conexão estabelecida com Lua'
                        }]);
                    };
                    
                    ws.onmessage = async (event) => {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'text') {
                            setMessages(prev => [...prev, {
                                type: 'assistant',
                                text: data.message
                            }]);
                        } else if (data.type === 'audio') {
                            // Convert base64 to audio and play
                            const audioData = atob(data.data);
                            const arrayBuffer = new ArrayBuffer(audioData.length);
                            const view = new Uint8Array(arrayBuffer);
                            for (let i = 0; i < audioData.length; i++) {
                                view[i] = audioData.charCodeAt(i);
                            }
                            
                            const blob = new Blob([arrayBuffer], { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(blob);
                            
                            if (audioRef.current) {
                                audioRef.current.src = audioUrl;
                                audioRef.current.play();
                                setIsSpeaking(true);
                            }
                        }
                    };
                    
                    ws.onerror = (error) => {
                        console.error("WebSocket erro:", error);
                        setMessages(prev => [...prev, {
                            type: 'error',
                            text: 'Erro na conexão'
                        }]);
                    };
                    
                    ws.onclose = () => {
                        console.log("WebSocket desconectado");
                    };
                    
                    setWsConnection(ws);
                    
                    return () => {
                        if (ws.readyState === WebSocket.OPEN) {
                            ws.close();
                        }
                    };
                }
            }, [conversationMode]);
            
            // Initialize Speech Recognition
            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.continuous = true;
                    recognition.interimResults = true;
                    recognition.lang = 'pt-BR';
                    
                    recognition.onstart = () => {
                        console.log("Reconhecimento de voz iniciado");
                        setIsListening(true);
                    };
                    
                    recognition.onresult = (event) => {
                        const transcript = Array.from(event.results)
                            .map(result => result[0])
                            .map(result => result.transcript)
                            .join('');
                        
                        if (event.results[0].isFinal) {
                            handleUserMessage(transcript);
                        }
                    };
                    
                    recognition.onerror = (event) => {
                        console.error("Erro no reconhecimento de voz:", event.error);
                        setIsListening(false);
                    };
                    
                    recognition.onend = () => {
                        console.log("Reconhecimento de voz finalizado");
                        setIsListening(false);
                    };
                    
                    recognitionRef.current = recognition;
                }
            }, []);
            
            // Initialize Audio Context for visualization
            useEffect(() => {
                if (conversationMode && audioRef.current) {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const analyserNode = context.createAnalyser();
                    analyserNode.fftSize = 256;
                    
                    const source = context.createMediaElementSource(audioRef.current);
                    source.connect(analyserNode);
                    analyserNode.connect(context.destination);
                    
                    setAudioContext(context);
                    setAnalyser(analyserNode);
                    
                    // Start audio visualization
                    visualizeAudio(analyserNode);
                }
            }, [conversationMode]);
            
            const visualizeAudio = (analyserNode) => {
                const dataArray = new Uint8Array(analyserNode.frequencyBinCount);
                
                const animate = () => {
                    if (!conversationMode) return;
                    
                    analyserNode.getByteFrequencyData(dataArray);
                    
                    const average = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                    const scale = 1 + (average / 255) * 0.3; // Scale between 1 and 1.3
                    
                    setSphereScale(scale);
                    
                    // Update audio bars
                    const bars = document.querySelectorAll('.audio-bar');
                    bars.forEach((bar, index) => {
                        const value = dataArray[index * 4] || 0;
                        bar.style.height = `${(value / 255) * 100}px`;
                    });
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            };
            
            const startConversationMode = () => {
                setConversationMode(true);
                
                // Check for "Lua, iniciar modo conversa" command
                if (recognitionRef.current && inputText.toLowerCase().includes("lua") && 
                    inputText.toLowerCase().includes("modo conversa")) {
                    setTimeout(() => {
                        recognitionRef.current.start();
                    }, 1000);
                }
            };
            
            const exitConversationMode = () => {
                setConversationMode(false);
                setIsListening(false);
                
                if (recognitionRef.current) {
                    recognitionRef.current.stop();
                }
                
                if (wsConnection) {
                    wsConnection.close();
                }
            };
            
            const handleUserMessage = (text) => {
                if (!text.trim()) return;
                
                setMessages(prev => [...prev, {
                    type: 'user',
                    text: text
                }]);
                
                if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
                    wsConnection.send(JSON.stringify({
                        type: 'chat',
                        message: text,
                        audio: true
                    }));
                }
                
                setInputText("");
            };
            
            const toggleListening = () => {
                if (recognitionRef.current) {
                    if (isListening) {
                        recognitionRef.current.stop();
                    } else {
                        recognitionRef.current.start();
                    }
                }
            };
            
            if (conversationMode) {
                return (
                    <div className="fixed inset-0 conversation-mode fade-in flex flex-col items-center justify-center">
                        {/* Exit button */}
                        <button
                            onClick={exitConversationMode}
                            className="absolute top-4 right-4 text-white/70 hover:text-white transition-colors z-20"
                        >
                            <i className="fas fa-times text-2xl"></i>
                        </button>
                        
                        {/* Energy Sphere */}
                        <div className="energy-sphere-container">
                            <div 
                                className="energy-sphere"
                                style={{ transform: `scale(${sphereScale})` }}
                            >
                                <video
                                    ref={videoRef}
                                    src="/videos/energy-sphere.mp4"
                                    autoPlay
                                    loop
                                    muted
                                    playsInline
                                    className="w-full h-full object-cover"
                                />
                            </div>
                            
                            {/* Audio Visualizer */}
                            <div className="audio-visualizer">
                                {Array.from({ length: 30 }, (_, i) => (
                                    <div key={i} className="audio-bar" style={{ height: '20px' }}></div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Messages */}
                        <div className="absolute bottom-20 left-0 right-0 max-w-4xl mx-auto px-4">
                            <div className="bg-black/50 rounded-lg p-4 max-h-60 overflow-y-auto">
                                {messages.slice(-5).map((msg, index) => (
                                    <div key={index} className={`mb-2 ${
                                        msg.type === 'user' ? 'text-blue-300' :
                                        msg.type === 'assistant' ? 'text-green-300' :
                                        msg.type === 'error' ? 'text-red-300' :
                                        'text-gray-300'
                                    }`}>
                                        <span className="font-bold">
                                            {msg.type === 'user' ? 'Você: ' :
                                             msg.type === 'assistant' ? 'Lua: ' : ''}
                                        </span>
                                        {msg.text}
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Controls */}
                        <div className="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                            <button
                                onClick={toggleListening}
                                className={`px-6 py-3 rounded-full transition-all ${
                                    isListening 
                                        ? 'bg-red-500 hover:bg-red-600 animate-pulse' 
                                        : 'bg-blue-500 hover:bg-blue-600'
                                } text-white`}
                            >
                                <i className={`fas fa-microphone ${isListening ? 'animate-pulse' : ''}`}></i>
                                {isListening ? ' Ouvindo...' : ' Falar'}
                            </button>
                        </div>
                        
                        {/* Hidden audio element */}
                        <audio ref={audioRef} onEnded={() => setIsSpeaking(false)} />
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-black">
                    <div className="container mx-auto px-4 py-8">
                        <header className="text-center mb-12">
                            <h1 className="text-5xl font-bold text-white mb-4">
                                <i className="fas fa-robot mr-3"></i>
                                Lua - Assistente IA
                            </h1>
                            <p className="text-xl text-gray-300">
                                Sistema de Conversação Inteligente com Síntese de Voz
                            </p>
                        </header>
                        
                        <div className="max-w-2xl mx-auto">
                            <div className="bg-white/10 backdrop-blur-md rounded-xl p-8">
                                <div className="mb-6">
                                    <label className="block text-white mb-2">Digite ou diga o comando:</label>
                                    <input
                                        type="text"
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') {
                                                if (inputText.toLowerCase().includes("lua") && 
                                                    inputText.toLowerCase().includes("modo conversa")) {
                                                    startConversationMode();
                                                } else {
                                                    handleUserMessage(inputText);
                                                }
                                            }
                                        }}
                                        placeholder='Diga "Lua, iniciar modo conversa" para começar'
                                        className="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                
                                <button
                                    onClick={startConversationMode}
                                    className="w-full py-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105"
                                >
                                    <i className="fas fa-comments mr-2"></i>
                                    Iniciar Modo Conversa
                                </button>
                                
                                <div className="mt-8 grid grid-cols-2 gap-4">
                                    <div className="bg-white/10 rounded-lg p-4 text-center">
                                        <i className="fas fa-microphone text-3xl text-blue-400 mb-2"></i>
                                        <p className="text-white">Reconhecimento de Voz</p>
                                    </div>
                                    <div className="bg-white/10 rounded-lg p-4 text-center">
                                        <i className="fas fa-volume-up text-3xl text-green-400 mb-2"></i>
                                        <p className="text-white">Síntese de Voz</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mt-8 text-center text-gray-400">
                                <p>Powered by Kokoro TTS & FastAPI</p>
                                <p className="text-sm mt-2">
                                    <i className="fas fa-info-circle mr-1"></i>
                                    Pressione ESC para sair do modo conversa
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<LuaAssistant />, document.getElementById('root'));
    </script>
</body>
</html>